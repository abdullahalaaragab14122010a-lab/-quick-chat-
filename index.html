<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Quick Chat Firebase</title>
<style>
body{
    font-family: Arial;
    background:#f2f2f2;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:20px;
}
.container{
    background:#fff;
    padding:20px;
    width:400px;
    border-radius:10px;
    box-shadow:0 0 10px #aaa;
    margin-bottom:20px;
}
input, button{
    width:100%;
    padding:10px;
    margin:5px 0;
}
#chatBox{
    display:none;
}
#messages{
    height:250px;
    border:1px solid #ccc;
    overflow-y:auto;
    padding:5px;
    margin-bottom:10px;
}
.msg{
    margin:5px 0;
}
.me{color:blue;}
.other{color:green;}
.chatList div{
    padding:5px;
    border-bottom:1px solid #eee;
    cursor:pointer;
}
</style>
</head>
<body>

<!-- Sign Up / Login -->
<div class="container" id="authBox">
<h3>تسجيل دخول / حساب جديد</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="signupBtn">إنشاء حساب</button>
<button id="login()">دخول</button>
</div>

<!-- Chat Interface -->
<div class="container" id="chatBox">
<h3 id="welcome"></h3>
<button id="logout()">تسجيل خروج</button>
<hr>
<h4>قائمة دردشاتك</h4>
<div class="chatList" id="chatList"></div>
<hr>
<input id="searchEmail" placeholder="ابحث عن مستخدم بالإيميل لبدء شات">
<button id="startChat()">ابدأ شات</button>
<hr>
<div id="messages"></div>
<input id="msgInput" placeholder="اكتب رسالة">
<button id="sendMsg()">إرسال</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXMvQWlb5xmX0DGMxC3xtOExib4_EacEk",
  authDomain: "quick-chat-53fbb.firebaseapp.com",
  projectId: "quick-chat-53fbb",
  storageBucket: "quick-chat-53fbb.firebasestorage.app",
  messagingSenderId: "625877774608",
  appId: "1:625877774608:web:476fb494ae237319a63595"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentChatId = null;

/* متابعة حالة المستخدم */
onAuthStateChanged(auth, user => {
    if(user){
        currentUser = user;
        document.getElementById("authBox").style.display = "none";
        document.getElementById("chatBox").style.display = "block";
        document.getElementById("welcome").innerText = "أهلاً " + user.email;
        loadChats();
    } else {
        currentUser = null;
        document.getElementById("authBox").style.display = "block";
        document.getElementById("chatBox").style.display = "none";
    }
});

/* إنشاء حساب */
async function signUp(){
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!email || !password){alert("اكتب الإيميل والباسورد"); return;}
    try{
        const userCred = await createUserWithEmailAndPassword(auth,email,password);
        await setDoc(doc(db,"users",userCred.user.uid),{email});
        alert("تم إنشاء الحساب بنجاح!");
    }catch(err){alert(err.message);}
}
document.getElementById("signupBtn").addEventListener("click", signUp);

/* تسجيل دخول */
async function login(){
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!email || !password){alert("اكتب الإيميل والباسورد"); return;}
    try{
        await signInWithEmailAndPassword(auth,email,password);
    }catch(err){alert(err.message);}
}

/* تسجيل خروج */
function logout(){ signOut(auth); currentChatId=null; document.getElementById("messages").innerHTML=""; }

/* البدء في شات مع مستخدم */
async function startChat(){
    const targetEmail = document.getElementById("searchEmail").value.trim();
    if(!targetEmail){alert("اكتب الإيميل"); return;}
    const usersRef = collection(db,"users");
    const q = query(usersRef, where("email","==",targetEmail));
    const querySnap = await getDocs(q);
    if(querySnap.empty){alert("المستخدم غير موجود"); return;}
    const targetUser = querySnap.docs[0].data();
    const targetUid = querySnap.docs[0].id;

    // انشاء chatId ثابت للطرفين
    const chatId = [currentUser.uid,targetUid].sort().join("_");
    currentChatId = chatId;
    await setDoc(doc(db,"chats",chatId),{users:[currentUser.uid,targetUid]},{merge:true});
    loadChats();
    loadMessages();
}

/* تحميل قائمة الدردشات */
async function loadChats(){
    const chatsDiv = document.getElementById("chatList");
    chatsDiv.innerHTML="";
    const chatsRef = collection(db,"chats");
    const q = query(chatsRef, where("users","array-contains",currentUser.uid));
    const querySnap = await getDocs(q);
    querySnap.forEach(docSnap=>{
        const div = document.createElement("div");
        div.innerText = "Chat مع "+ docSnap.data().users.filter(u=>u!==currentUser.uid).join(",");
        div.onclick = ()=>{
            currentChatId = docSnap.id;
            loadMessages();
        };
        chatsDiv.appendChild(div);
    });

/* إرسال رسالة */
async function sendMsg(){
    if(!currentChatId){alert("اختار شات اولاً"); return;}
    const msg = document.getElementById("msgInput").value.trim();
    if(!msg) return;
    await addDoc(collection(db,"chats",currentChatId,"messages"),{
        sender: currentUser.uid,
        text: msg,
        time: new Date()
    });
    document.getElementById("msgInput").value="";
}

/* تحميل الرسائل */
function loadMessages(){
    if(!currentChatId) return;
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML="";
    const messagesRef = collection(db,"chats",currentChatId,"messages");
    const q = query(messagesRef, orderBy("time"));
    onSnapshot(q,snap=>{
        messagesDiv.innerHTML="";
        snap.forEach(docSnap=>{
            const m = docSnap.data();
            const div = document.createElement("div");
            div.className="msg "+(m.sender===currentUser.uid?"me":"other");
            div.innerText=m.text;
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}
</script>

</body>
</html>


